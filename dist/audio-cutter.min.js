/***********************************************************************
 *
 * Copyright (c) 2023 Amurik Khoyetsyan
 *
 * The MIT License (MIT)
 *
 * When we bring the file closer to the installation area
 * a new class is added to the installation section called "dragover",
 * with which we can shape the installation areaâ€¤
 *
 ************************************************************************/

!function(){let t={name:"Audio Cutter",version:"0.0.1"};t.defaultData={parent:null,audio:null,audioContext:null,ctx:null,bufferAudioData:null,duration:null,canvas:null,isSelected:!1,mask:null,rect:null,startX:null,endX:null,option:{waveColor:"#FFAA00",backgroundMask:"rgba(232,109,109,0.42)",callBack:null,playAfterCut:!1,isDownload:!1,name:"cut_audio.wav",removeContent:!1}},t.fullData={},t.loadAudio=async function(t=null){let a=this;return t=null===t?a.fullData.audio:t,new Promise((l,e)=>{fetch(t).then(t=>t.arrayBuffer()).then(t=>a.fullData.audioContext.decodeAudioData(t)).then(t=>{l(t)}).catch(t=>{console.log(t),e(t)})})},t.mousedown=function(){if(null!==this.fullData.canvas){let t=this;document.addEventListener("mousedown",a=>{t.fullData.isSelected=!1,t.fullData.mask.style.left=0,t.fullData.mask.style.width=0;let l=t.fullData.parent.getBoundingClientRect();a.clientY>=l.y&&a.clientY<=l.y+l.height&&a.clientX>=l.x&&a.clientX<=l.x+l.width?(t.fullData.startX=(a.clientX-t.fullData.rect.left)/t.fullData.canvas.width*t.fullData.duration,t.fullData.isSelected=!0):t.fullData.isSelected=!1})}},t.mouseup=function(){if(null!==this.fullData.canvas){let t=this;document.addEventListener("mouseup",a=>{let l=t.fullData.parent.getBoundingClientRect();a.clientY>=l.y&&a.clientY<=l.y+l.height&&a.clientX>=l.x&&(a.clientX,l.x,l.width),t.fullData.isSelected=!1})}},t.mousemove=function(){if(null!==this.fullData.canvas){let t=this;document.addEventListener("mousemove",a=>{let l=t.fullData.parent.getBoundingClientRect();if(a.clientY>=l.y&&a.clientY<=l.y+l.height&&a.clientX>=l.x&&a.clientX<=l.x+l.width){if(t.fullData.isSelected){if(t.fullData.endX=(a.clientX-t.fullData.rect.left)/t.fullData.canvas.width*t.fullData.duration,null!==t.fullData.mask){let e=Math.abs(t.fullData.endX-t.fullData.startX)/t.fullData.duration*100,n=Math.min(t.fullData.startX,t.fullData.endX)/t.fullData.duration*100;t.fullData.mask.style.left=n+"%",t.fullData.mask.style.width=e+"%"}null!==t.fullData.option.callBack&&t.fullData.option.callBack(Math.min(t.fullData.startX,t.fullData.endX),Math.max(t.fullData.startX,t.fullData.endX))}}else t.fullData.isSelected=!1})}},t.createWavForm=async function(){this.fullData.canvas=document.createElement("canvas"),this.fullData.canvas.width=this.fullData.parent.clientWidth,this.fullData.canvas.height=this.fullData.parent.clientHeight,this.fullData.parent.appendChild(this.fullData.canvas),this.fullData.ctx=this.fullData.canvas.getContext("2d"),this.fullData.bufferAudioData=await this.loadAudio(),this.fullData.ctx.fillStyle=this.fullData.option.waveColor,this.fullData.duration=this.fullData.bufferAudioData.duration;let t=this.fullData.bufferAudioData.getChannelData(0),a=Math.ceil(t.length/this.fullData.canvas.width),l=this.fullData.canvas.height/2;for(let e=0;e<this.fullData.canvas.width;e++){let n=Math.min.apply(null,t.subarray(e*a,(e+1)*a)),u=Math.max.apply(null,t.subarray(e*a,(e+1)*a));this.fullData.ctx.fillRect(e,(1+n)*l,1,Math.max(1,(u-n)*l))}this.fullData.rect=this.fullData.canvas.getBoundingClientRect(),this.mousedown(),this.mouseup(),this.mousemove()},t.createMask=function(){this.fullData.mask=document.createElement("div"),this.fullData.mask.setAttribute("data-audio-cutter",!0),this.fullData.mask.style.top="0",this.fullData.mask.style.height=this.fullData.canvas.height+"px",this.fullData.mask.style.position="absolute",this.fullData.mask.style["background-color"]=this.fullData.option.backgroundMask,this.fullData.parent.style.position="relative",this.fullData.parent.appendChild(this.fullData.mask)},t.cut=function(t=null,a=null,l=null,e=null){let n=this;return t=null===t?n.fullData.audio:t,a=null===a?n.fullData.startX:a,l=null===l?n.fullData.endX:l,e=null===e?e=n.defaultData.option.removeContent:e,new Promise((u,i)=>{let s=new(window.AudioContext||window.webkitAudioContext),o=new FileReader;o.onload=function(t){s.decodeAudioData(t.target.result,function(t){let i=e?function t(a,l,e){let n=new(window.AudioContext||window.webkitAudioContext),u=a.sampleRate,i=a.getChannelData(0).slice(0,Math.floor(l*u)),s=a.getChannelData(0).slice(Math.floor(e*u)),o=new Float32Array(i.length+s.length);o.set(i,0),o.set(s,i.length);let f=n.createBuffer(1,o.length,u);return f.getChannelData(0).set(o),f}(t,a,l):function t(a,l,e){let n=new(window.AudioContext||window.webkitAudioContext),u=a.numberOfChannels,i=Math.floor((e-l)*a.sampleRate),s=n.createBuffer(u,i,a.sampleRate);for(let o=0;o<u;o++){let f=a.getChannelData(o),r=s.getChannelData(o);for(let c=0;c<i;c++){let h=Math.floor((l+c/a.sampleRate)*a.sampleRate);r[c]=f[h]}}return s}(t,a,l),o=s.createBufferSource();o.buffer=i,o.connect(s.destination),n.fullData.option.playAfterCut&&o.start();let f=function t(a){let l=a.numberOfChannels,e=a.length,n=a.sampleRate,u=new Float32Array(e*l),i=[];for(let s=0;s<l;s++)i.push(a.getChannelData(s));for(let o=0;o<e;o++)for(let f=0;f<l;f++)u[o*l+f]=i[f][o];let r=2*u.length,c=new ArrayBuffer(44+r),h=new DataView(c);h.setUint32(0,1380533830,!1),h.setUint32(4,36+r,!0),h.setUint32(8,1463899717,!1),h.setUint32(12,1718449184,!1),h.setUint32(16,16,!0),h.setUint16(20,1,!0),h.setUint16(22,l,!0),h.setUint32(24,n,!0),h.setUint32(28,4*n,!0),h.setUint16(32,2*l,!0),h.setUint16(34,16,!0),h.setUint32(36,1684108385,!1),h.setUint32(40,r,!0);let D=44;for(let d=0;d<u.length;d++,D+=2)h.setInt16(D,32767*u[d],!0);return new Blob([h],{type:"audio/wav"})}(i),r=URL||webkitURL,c=r.createObjectURL(f);if(n.fullData.option.isDownload){let h=document.createElement("a");h.href=c,h.download=n.fullData.option.name,h.click(),h.remove()}u(c)})},o.onerror=function(t){i(t)},o.readAsArrayBuffer(t)})},t.reset=function(){this.fullData.hasOwnProperty("canvas")&&null!==this.fullData.canvas&&this.fullData.canvas.remove(),this.fullData.hasOwnProperty("mask")&&null!==this.fullData.mask&&this.fullData.mask.remove(),this.fullData={...this.defaultData}},t.run=function(t,a,l={waveColor:null,backgroundMask:null,callBack:null}){if(this.reset(),this.fullData.parent=t,this.fullData.audio=a,this.fullData.audioContext=new(window.AudioContext||window.webkitAudioContext),Object.keys(l).length>0)for(let e in l)this.fullData.option[e]=l[e];null!==t&&(this.createWavForm(),this.createMask())},window.AudioCutter=t}();
